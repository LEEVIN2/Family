<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="com.animal.mappers.BoardMapper"> 

	<insert id="writePro">
		insert into board(boardNum,title,content,nickname,submitTime)
		values(#{boardNum},#{title},#{content},#{nickname},#{submitTime})
	</insert>
	
	<insert id="writePro2">
		insert into comment(boardNum,nickname,content,submitTime)
		values(#{boardNum},#{nickname},#{content},#{submitTime})
	</insert>
	
	<insert id="addFilePath">
    	insert into board_file(boardNum, filePath)
    	values(#{boardNum}, #{filePath})
	</insert>
	
	<select id="getFreesearchList" resultType="com.animal.domain.BoardDTO">
    <if test="search == null or search == ''">
        select *
        from board
        where 1 = 0
    </if>
    <if test="search != null and search != ''">
        select *
        from board
        where nickname like concat('%', #{search}, '%')
        or title like concat('%', #{search}, '%')
        or content like concat('%', #{search}, '%')
    </if>
</select>
	
	<select id="getBoardList" resultType="com.animal.domain.BoardDTO">
		SELECT b.boardNum, b.nickname, b.submitTime, b.title, b.content, f.filePath, b.viewCnt, co.commentCnt, li.board_likeCnt
FROM board b
LEFT JOIN (
	SELECT boardNum, filePath
	FROM board_file
	WHERE (boardNum, fileNum) IN (
		SELECT boardNum, MAX(fileNum)
		FROM board_file
		GROUP BY boardNum)
) as f ON b.boardNum = f.boardNum
LEFT JOIN (
	SELECT boardNum, COUNT(*) as commentCnt
	FROM comment
	GROUP BY boardNum
) as co ON b.boardNum = co.boardNum
LEFT JOIN (
	SELECT boardNum, COUNT(*) as board_likeCnt
	FROM board_like
	GROUP BY boardNum
) as li ON b.boardNum = li.boardNum
order by boardNum desc limit #{startRow}, #{pageSize};
	</select>
	
	<select id="getBoardHotList" resultType="com.animal.domain.BoardDTO">
		SELECT * FROM (
    SELECT b.boardNum, b.nickname, b.submitTime, b.title, b.content, f.filePath, b.viewCnt, co.commentCnt, li.board_likeCnt
    FROM board b
    LEFT JOIN (
        SELECT boardNum, filePath
        FROM board_file
        WHERE (boardNum, fileNum) IN (
            SELECT boardNum, MAX(fileNum)
            FROM board_file
            GROUP BY boardNum)
    ) as f ON b.boardNum = f.boardNum
    LEFT JOIN (
        SELECT boardNum, COUNT(*) as commentCnt
        FROM comment
        GROUP BY boardNum
    ) as co ON b.boardNum = co.boardNum
    LEFT JOIN (
        SELECT boardNum, COUNT(*) as board_likeCnt
        FROM board_like
        GROUP BY boardNum
    ) as li ON b.boardNum = li.boardNum
    WHERE co.commentCnt >= 3 OR li.board_likeCnt >= 3
    ORDER BY b.submitTime DESC
) AS result;
	</select>
	
	<select id="getCommentList" resultType="com.animal.domain.BoardDTO">
	SELECT *
    FROM comment
	</select>
	
	 <select id="getDetail" resultType="com.animal.domain.BoardDTO">
    SELECT *
    FROM board
    WHERE board.boardNum = #{boardNum};
</select>

<!-- 좋아요 눌럿는지 안눌럿는지 -->
	<select id="findLike" resultType="int">
		select count(*)
		from board_like
		where boardNum = #{boardNum} and nickname = #{nickname};
	</select>
	
	<select id="findLikeCnt" resultType="int">
		select count(*)
		from board_like
		where boardNum = #{boardNum};
	</select>
	
	<insert id="likeUp">
		insert into board_like(boardNum, nickname)
		values (#{boardNum}, #{nickname});
	</insert>
	
	<delete id="likeDown">
	  	delete from board_like
	  	where boardNum = #{boardNum} and nickname = #{nickname};
	  </delete>
	

<select id="getFilePaths" resultType="string">
    SELECT filePath
    FROM board_file
    WHERE board_file.boardNum = #{boardNum}
    order by fileNum desc
</select>

<update id="increaseViewCnt">
    UPDATE board
	SET viewCnt = IFNULL(viewCnt, 0) + 1
	WHERE boardNum = #{boardNum};
</update>

<select id="getFreeboardCount" resultType="java.lang.Integer">
		select count(*)
      	from board
    </select>

	
</mapper>